# 2.3 线性链CRFs

为了引出线性链CRFs，我们考虑从HMM的联合分布p(y,x)引出的条件分布p(y|x)。关键点在于，这一条件分布是一种具有特殊的特征方程的CRF。

首先，我们来重写HMM的联合分布(2.10)，使其更利于扩展，即：

$$
p(y,x)=\frac{1}{Z}\prod^T_{t=1}exp\left\{\sum_{i,j\in S}\theta_{ij}1_{\{y_t=i\}}1_{\{y_{t-1}=j\}}+\sum_{i\in S}\sum_{o\in O}\mu_{oi}1_{\{y_t=i\}1_{\{x_t=o\}}}\right\} (2.15)
$$

其中，$$\theta=\{\theta_{ij},\mu_{oi}\}$$是分布的实值参数，Z是归一化常数，能使分布的和为1。如果我们不在(2.15)中添加Z，那么参数$$\theta$$有可能带来不合理的关于(y,x)的分布，如当所有参数都是1时。

现在有意思的是，(2.15)(几乎)确切地描述了(2.10)一类的HMMs。每个同类的HMM都可通过如下设置，写成(2.15)的形式：

$$\theta_{ij}=\log p(y'=i|y=j)$$

$$\mu_{oi}=\log p(x=o|y=i)$$

$$Z=1$$

反过来也是正确的，即是说，每个按照(2.15)分解的分布都是HMM。(利用4.1节介绍的前向-反向算法，可构造对应的HMM，从而证明这一点)。因而尽管在参数中增加了灵活性，我们却没有扩大分布簇。

通过使用**特征函数feature functions**，我们可以把(2.15)弄得更紧凑，正如我们在(2.9)的逻辑回归那里一样。每个特征函数都具有形式$$f_k(y_t,y_{t-1},x_t)$$。对于(2.15)，我们需要给每个转移(i,j)一个特征$$f_{ij}(y,y',x)=1_{\{y=i\}}1_{\{y'=j\}}$$，以及给每个“状态-特征对”$$(i,o)$$一个特征$$f_{io}(y,y',x)=1_{\{y=i\}}1_{\{x=o\}}$$。 我们泛泛地用$$f_k$$来引用一个特征，其中$$f_k$$涵盖了全部都的$$f_{ij}$$和全部的$$f_{io}$$。于是，我们可以重写HMM如下：

$$
p(y,x)=\frac{1}{Z}\prod^T_{t=1}\exp\left\{\sum^K_{k=1}\theta_kf_k(y_t,y_{t-1},x_t)\right\} (2.16)
$$

再一次，方程(2.16)定义了与(2.15)完全一样的分布簇，从而也与最初的HMM方程(2.10)一样。

最后一步，是把来自HMM(2.16)的条件分布$$p({y|x})$$写出来，即：

$$
p(y|x)=\frac{p(y,x)}{\sum_{y'}p(y',x)}=\frac{\prod^T_{t=1}exp\left\{\sum^K_{k=1}\theta_kf_k(y_t,y_{t-1},x_t)\right\}}{\sum_{y'}\prod^T_{t=1}exp\left\{\sum^K_{k=1}\theta_kf_k(y'_t,y'_{t-1},x_t)\right\}} (2.17)
$$

(2.17)所描述的条件分布，是线性链CRF的一种特例，即那种只包含当前单词作为特征的。然而，很多线性链CRF使用更为丰富的特征，如前后缀等等。幸运的是，将我们现有的记号扩展并非难事。我们只需简单地允许特征函数包含更多的输入。这导致了我们关于线性链CRFs的一般定义

-----

**定义2.2** 记$$Y,X$$是随机向量，$$\theta=\{\theta_k\}\in \mathcal{R}^K$$是一个参数向量，$$\mathcal{F}=\{f_k(y,y',x_t)\}^K_{k=1}$$为一组实值特征函数。那么**线性链条件随机场**是如下形式的分布p(y|x)：
$$
p(y|x)=\frac{1}{Z}\prod^T_{t=1}exp\left\{\sum^K_{k=1}\theta_kf_k(y_t,y_{t-1},x_t)\right\} (2.18)
$$
其中，$$Z(x)$$是依赖于输入的归一化函数：
$$
Z(x)=\sum_y \prod^T_{t=1}exp\left\{\sum^K_{k=1}\theta_kf_k(y_t,y_{t-1},x_t)\right\} (2.19)
$$

----

<font color=red>译注：线性链条件随机场，好像是一类随机场，实际是一个随机场——结构是定死的。我觉得这是条件随机场最非常核心的问题，本文却并没有阐明。当然，它对输入的引用还是很灵活的。</font>

注意，线性链CRF可以用x和y上的因子图来描述，即

$$
p(y|x)=\frac{1}{Z(x)}\prod^T_{t=1}\Psi_t(y_t,y_{t-1},x_t) (2.20)
$$

其中，局部函数$$\Psi_t$$具有一种特殊的 log-linear形式：

$$
\Psi_t(y_t,y_{t-1},x_t)=exp\left\{\sum^K_{k=1}\theta_kf_k(y_t,y_{t-1},x_t)\right\} (2.21)
$$

当我们在下一节进入一般意义CRF的时候，这会很有用。

一般来说，我们将从数据中学得参数$$\theta$$。这将在第5节讲述。

之前我们已看到，如果一个联合分布p(y,x)像HMM一样分解了，那么对应的条件分布p(y|x)是一个线性链CRF。这一很像HMM的CRF如图2.5所示。

然而，其他类型的线性链CRFs也是有用的。例如，在一个HMM中，状态i到j的转移概率与输入无关，都是$$\log p(y_t=j|y_{t-1}=i)$$。在CRF中，我们可以让转移概率(i,j)依赖于当前的观测向量，这只需添加特征$$1_{\{y_t=j\}}1_{\{y_{t-1}=j\}}1_{\{x_t=o\}}$$。 具有这一转移特征的CRF常常被用于文本处理，如图2.6所示。

实际上，因为CRFs不在乎输入变量$$x_1,\cdots,x_T$$之间的关系，我们可以让因子$$\Psi_t$$依赖于所有的输入x。这不会大破线性图的结构——允许我们把x当成单一的整体变量。结果，特征函数可以写成$$f_k(y_t,y_{t-1},x)$$，从而可以把全部的输入变量x一块考虑。这一事实对CRFs都适用，而不只是对线性链。具有这一结构的线性链如图2.7所示。途中，我们把$$x=(x_1,\cdots,x_T)$$画成一个巨大的观测节点，并被所有的因子依赖，而不是把$$x_1,\cdot,x_T$$画成独立的节点。

![](/assets/2.5.png)

图2.5 来自式(2.17)的类HMM的线性链CRF

![](/assets/2.6.png)

图2.6 转移因子依赖于当前输入的线性链CRF

![](/assets/2.7.png)

图2.7 转移因子依赖于全部输入的线性链CRF

需支出，在我们关于线性链CRF的定义中，特征函数可以从任意时刻依赖于输入，把$$f_k$$关于输入的参数写成了$$x_t$$。$$x_t$$应当被理解成——计算$$t$$时刻特征所需的全部输入<font color=red>译注：而不是t时刻的输入</font>。 例如，如果CRF需要下一时刻的单词$$x_{t+1}$$，那么$$x_t$$应当包含了$$x_{t+1}$$。

最后，归一化常数Z(x)需要在全部 可能的输出序列上求和，包含有爆炸式的大量的项。然而，它可以被前向-反向算法有效地解，正如我们在第4.1节所揭示的。