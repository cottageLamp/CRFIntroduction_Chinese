# 2.6 例子

这一节，我们提供两个CRF是应用的细节。第一个是自然语言文本的线性链CRF，而第二个是计算机视觉的网状CRF。

## 2.6.1 命名实体识别

暂略

## 2.6.2 图片分割Image Labeling

许多不同的CRF拓扑结构被用于计算机视觉。作为一个例子，我们希望根据前景和背景来对图片的区域分类。亦或按照人工构造物和非人工构造物【61,62】；天空、水域和菜地等来分类【49】。

正式地，记$$x=(x_1,x_2,\cdots,x_T)$$为一个向量，表示一张$$\sqrt{T}\times\sqrt{T}$$的图片。就是说，$${x}_{1:\sqrt{T}}$$代表第一行，$${x}_{\sqrt{T}}+1：\sqrt{T}+2$$表示第二行，依次类推。每个$$x_i$$表示某个像素的值。简单起见，只考虑黑白图片，那么每个$$x_i$$都是0~255的一个实值，表示位置$$i$$的像素的亮度。(这可以轻易地扩展到彩色图)。目的是推断一个向量$${y}=(y_1,y_2,\cdots,y_T)$$，其中每个$$y_i$$是位子i的标签，如+1表示人工构造物，而-1表示其他。

已有大量的计算机视觉文献，贡献了大量的图像特征。例如，给定一个像素位置i，我们可以计算其$$5\times 5$$的窗口内的亮度直方图，然后把每个柱体里的像素个数作为特征。通常会使用更复杂的特征，如图像的梯度特征，texton特征【127】以及SIFT特征【77】。重要的是，这些特征不只依赖于像素$$x_i$$自身，而是一个领域或全图的像素。

图片有一个基本的特征，就是临近的像素趋向属于相同的类别。把这一想法融入模型的办法是引入一个先验的y的分布，增加“光滑”分割的概率。计算机视觉中最常见的先验分布是网状的五香图模型，叫做**马尔科夫随机场Markov random field[10]**。MRF是拥有两种因子的无向模型：一种因子把标签$$y_i$$与对应的像素$$x_i$$联系起来，另一种鼓励邻近的标签$$y_i$$和$$y_j$$相一致。

正式地，用$$\mathcal{N}$$定义像素间的邻居关系，即当$$x_i$$和$$x_j$$属于邻居时，$$(i,j)\in\mathcal{N}$$。一般来说，$$\mathcal{N}$$的定义需使能构成一个$$\sqrt{T}\times\sqrt{T}$$。一个MRF是一个生成模型：
$$
p({y})=\frac{1}{Z}\prod_{(i,j)\in\mathcal{N}}\Psi(y_i,y_j)\\
p({y,x})=p({y})\prod^T_{i=1}p(x_i|y_i).(2.32)
$$
其中，$$\Psi$$是鼓励光滑性的因子。通常在$$y_i=y_j$$时，让$$\Psi(y_i,y_j)=1$$，而其他时候为$$\alpha$$，而$$\alpha<1$$是从数据中学到的参数。其背后的想法是，当$$\alpha<1$$时，存在快速的推断算法用来最大化$$\log p({y,x})$$。$$p(x_i|y_i)$$是像素值关于类别的条件分布。例如，$$x_i$$上的混合高斯。

MRF的缺点在于，很难使用一个区域上的特征。否则，$$p({x|y})$$会变拥有很复杂的结构。条件模型提供了一个解决之道。

关于本任务，我们描述的CRF与MRF很像，但却允许因子依赖于单个或连接的像素的任何特征。记$$q(x_i)$$为在$$x_i$$附近的区域上提取的特征，例如颜色直方图或图像梯度。进一步，我们定义$$x_i$$和$$x_j$$之间的特征向量$$v(x_i,x_j)$$，以使模型能够处理$$x_i$$与$$y_i$$之间的相似与不同。一种办法是把$$v(x_i,x_j)$$定义为$$q(x_i)$$和$$q(x_j)$$的叉乘，就是说，线计算矩阵$$q(x_i)q(x_j)^T$$，然后展平成一个向量。

我们一直把$$q$$和$$v$$称为特征，这是计算机视觉领域的惯用名。然而本文所说的特征需要同时依赖输入$${x}$$和标签$${y}$$。所以，我们把$$q$$和$$v$$称为观测函数，并用于定义CRF的label-observation特征：
$$
f_m(y_i,x_i)={1}_{\{y_i=m\}}\forall m\in\{0,1\}\\
g_{m,m'}(y_i,y_j,x_i,x_j)={1}_{\{y_i=m\}}{1}_{\{y_j=m\}}v(x_i,x_j))\forall m,m'\in\{0,1\}\\
f(y_i,x_i)=\left(\begin{matrix}
f_0(y_i,x_i)\\
f_1(y_i,x_i)
\end{matrix}\right)\\
g(y_i,y_j,x_i,x_j)=\left(\begin{matrix}
g_{00}(y_i,y_j,x_i,x_j)\\
g_{01}(y_i,y_j,x_i,x_j)\\
g_{10}(y_i,y_j,x_i,x_j)\\
g_{11}(y_i,y_j,x_i,x_j)
\end{matrix}\right)
$$
使用label-observation特征，可允许每个标签拥有自己独立的权重集。

为了让本例子更具体，这里提供一个已被一些杰出的应用【14,119】所采用的$$g$$和$$v$$。<font color=red>前文用的是q，估计是笔误。</font>考虑(2.32)MRF中的因子$$\Psi(y_i,y_j)$$。虽然$$\Psi$$鼓励了一致性，但缺乏灵活性。如果$$x_i$$和$$x_j$$具有不同的标签，我们期望他们具有不同的灰度，因为不同的物体倾向于拥有不同的色度。因而，当类别分界线的两边具有明显不同的亮度时，我们不会那么惊讶(相比于完全相同的亮度)。遗憾的是，$$\Psi$$对这两种情况使用了相同的差异惩罚，因为特征(potential？)与像素值无关。为了解决这个问题，推荐使用下面的特征：
$$
v(x_i,x_j)=exp\left\{-\beta(x_i-x_j)^2\right\}\\
g(y_i,y_j,x_i,x_j)={1}_{\{y_i\neq y_j\}}v(x_i,x_j).(2.33)
$$
综合起来，CRF模型是：
$$
p({y|x})=\frac{1}{Z({x})}exp\left\{\sum^T_{i=1}\theta^Tf(y_i,x_i)+\sum_{(i,j)\in\mathcal{N}}\lambda^Tg(y_i,y_j,x_i,x_j)\right\}.(2.34)
$$
其中，$$\alpha\in\mathcal{R}, \theta\in\mathcal{R}^K, \lambda\in\mathcal{R}^{K^2}$$，是模型的参数。前两项与MRF中的两种因子相类似。第一项表示在$$x_i$$附近所得到的关于其标签$$y_i$$的信息。 使用(2.23)所描述的$$g$$，第二项鼓励近邻的标签相同，但要看他们亮度的差异。

注意，这是(2.25)所示的通用CRF的一个例子。这里，我们有3个团模板，每个对应于(2.34)的一项。

(2.34)与(2.32)之间的不同，类似于图2.6和2.5的线性链CRF模型的不同：“像素对”之上的特征现在不只与标签有关，还与图像上反映的特征有关。顺带说明一下，从(2.32)MRF模型所得到的分布$$p({y|x})$$是CRF的一个特例，即$$\lambda=0$$。

有很多方法可以改进这一简单的CRF。第一，特征函数$$q$$和$$v$$可以更加复杂，如将形状和纹理考虑进来【127】，或者依赖于全图(而不只是局部的领域)。更进一步，我们可以使用比网格更复杂的图结构。例如，可以让因子建立在标签的领域上【49,56】。关于计算机视觉中更深入的CRF及其图结构，可以参考Nowozin和Lampert【101】